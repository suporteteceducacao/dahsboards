<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPAECE Analytics Pro V14.4 - Final</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&family=OpenDyslexic&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root { --primary: #0f172a; --accent: #4f46e5; --sidebar-w: 280px; --bg-app: #f8fafc; }
        body.dark-mode { --bg-app: #0f172a; --text-main: #f8fafc; }
        body.dark-mode .glass-card, body.dark-mode .modal-content { background: #1e293b; color: white; border-color: #334155; }
        body.dyslexic { font-family: 'OpenDyslexic', sans-serif !important; }
        body { background-color: var(--bg-app); font-family: 'Inter', sans-serif; transition: 0.3s; }

        /* LOGIN E LOADING */
        #login-overlay { position: fixed; inset: 0; z-index: 9999; background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%); display: flex; align-items: center; justify-content: center; }
        .login-card { background: white; padding: 40px; border-radius: 32px; width: 420px; text-align: center; box-shadow: 0 25px 50px rgba(0,0,0,0.5); }
        #loading-screen { position: fixed; inset: 0; z-index: 9998; background: var(--bg-app); display: none; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 50px; height: 50px; border: 5px solid #e2e8f0; border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* SIDEBAR */
        #sidebar { width: var(--sidebar-w); height: 100vh; position: fixed; background: var(--primary); color: white; padding: 20px; transition: 0.3s; z-index: 1000; }
        #sidebar.collapsed { left: -280px; }
        #content { margin-left: var(--sidebar-w); padding: 40px; transition: 0.3s; }
        #content.expanded { margin-left: 0; }

        .glass-card { background: white; border-radius: 20px; padding: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 25px; border: 1px solid #e2e8f0; position: relative; }
        
        /* CORES ORIGINAIS */
        .card-critico { background: #ef4444; color: white; }
        .card-alerta { background: #facc15; color: #000; }
        .card-bom { background: #86efac; color: #000; }
        .card-excelente { background: #166534; color: white; }
        
        .val-pill { padding: 4px 12px; border-radius: 20px; font-weight: 800; font-size: 14px; }
        .val-esc { background: #eef2ff; color: #4338ca; }

        /* MODAL SUMÁRIO */
        .modal-xl { max-width: 1140px; }
        .sumario-secao { border-bottom: 1px solid #e2e8f0; padding: 20px 0; }
        .sumario-grid-img { background: #fff; border-radius: 15px; padding: 15px; border: 1px solid #eee; }
    </style>
</head>
<body>

<div id="login-overlay">
    <div class="login-card">
        <h4 class="fw-800">SPAECE ANALYTICS</h4>
        <input type="text" id="inepInput" class="form-control text-center my-4 py-3" placeholder="Código INEP" style="border-radius:15px">
        <button class="btn btn-primary w-100 fw-bold py-3" onclick="entrar()" style="border-radius:15px">ACESSAR SISTEMA</button>
        <div id="login-status" class="small mt-3 text-muted">Aguardando...</div>
    </div>
</div>

<div id="loading-screen">
    <div class="spinner mb-3"></div>
    <h5 class="fw-bold">Sincronizando Dados...</h5>
</div>

<div id="app" style="display:none;">
    <aside id="sidebar">
        <div class="mt-4 text-center mb-5"><h5 class="fw-800">PAINEL OFICIAL</h5></div>
        <label class="small fw-bold opacity-50">ETAPA</label>
        <select id="selEtapa" class="form-select bg-dark text-white border-0 mb-4" onchange="popularComponentes()"></select>
        <label class="small fw-bold opacity-50">COMPONENTE</label>
        <select id="selComp" class="form-select bg-dark text-white border-0 mb-5" onchange="render()"></select>
        
        <button class="btn btn-info w-100 fw-bold text-white mb-3 shadow" onclick="abrirSumario()">
            <i class="fas fa-file-contract me-2"></i>SUMÁRIO EXECUTIVO
        </button>
        <button class="btn btn-outline-danger w-100 fw-bold" onclick="location.reload()">SAIR</button>
    </aside>

    <main id="content">
        <header class="mb-4">
            <h2 id="hEscola" class="fw-800 text-primary mb-0">---</h2>
            <p id="hInep" class="text-muted fw-bold">---</p>
        </header>

        <ul class="nav nav-pills mb-4" id="pills-tab">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#p-prof">PROFICIÊNCIA</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#p-ide">IDE</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#p-comp">REDE</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#p-niveis">NÍVEIS</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#p-hist">HISTÓRICO</button></li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="p-prof">
                <div class="glass-card"><canvas id="chartProf" height="350"></canvas></div>
            </div>
            <div class="tab-pane fade" id="p-ide">
                <div class="glass-card"><canvas id="chartIde" height="350"></canvas></div>
            </div>
            <div class="tab-pane fade" id="p-comp"><div id="gridComparativo"></div></div>
            <div class="tab-pane fade" id="p-niveis"><div id="gridNiveis"></div></div>
            <div class="tab-pane fade" id="p-hist"><div id="gridHistorico"></div></div>
        </div>
    </main>
</div>

<div class="modal fade" id="modalSumario" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-primary text-white p-4">
                <h4 class="fw-800 mb-0"><i class="fas fa-print me-2"></i>RELATÓRIO EXECUTIVO DE DESEMPENHO</h4>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0" id="print-area">
                <div class="p-5">
                    <div id="sum-header" class="text-center mb-5 border-bottom pb-4"></div>
                    
                    <div class="row g-3 mb-5" id="sum-cards-top"></div>

                    <div class="sumario-secao">
                        <h5 class="fw-800 text-primary mb-4">1. EVOLUÇÃO DE PROFICIÊNCIA E IDE</h5>
                        <div class="row">
                            <div class="col-md-6"><div class="sumario-grid-img"><img id="imgProf" class="img-fluid"></div></div>
                            <div class="col-md-6"><div class="sumario-grid-img"><img id="imgIde" class="img-fluid"></div></div>
                        </div>
                    </div>

                    <div class="sumario-secao">
                        <h5 class="fw-800 text-primary mb-4">2. DISTRIBUIÇÃO POR NÍVEIS (ÚLTIMA EDIÇÃO)</h5>
                        <div id="sum-niveis-detail"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer bg-light p-4">
                <button class="btn btn-secondary fw-bold px-4" data-bs-dismiss="modal">FECHAR</button>
                <button class="btn btn-success fw-bold px-4 shadow" onclick="gerarPDF()">
                    <i class="fas fa-file-pdf me-2"></i>EXPORTAR RELATÓRIO PDF
                </button>
            </div>
        </div>
    </div>
</div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxj9fSRN5Vsxmf7er8u4dwv3VG1L3Iba2qg24stpzU5gA-pfttuzXgsyK03-hO9PoL_/exec";
let database = [], chartP = null, chartI = null;
Chart.register(ChartDataLabels);

async function load() {
    try {
        const r = await fetch(WEB_APP_URL);
        database = await r.json();
        document.getElementById('login-status').innerText = "✓ Sincronizado";
    } catch(e) { document.getElementById('login-status').innerText = "Erro na rede."; }
}

function parse(v) { if(!v) return 0; return parseFloat(String(v).replace('%','').replace(',','.')) || 0; }

function entrar() {
    const inep = document.getElementById('inepInput').value;
    if(database.some(d => String(d.INEP_ESC || d.INEP) === inep)) {
        document.getElementById('login-overlay').style.display = 'none';
        document.getElementById('loading-screen').style.display = 'flex';
        setTimeout(() => {
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            const etapas = [...new Set(database.filter(d => String(d.INEP_ESC || d.INEP) === inep).map(d => d.ETAPA))].sort();
            document.getElementById('selEtapa').innerHTML = etapas.map(e => `<option>${e}</option>`).join('');
            popularComponentes();
        }, 1200);
    } else { alert("INEP Inválido!"); }
}

function popularComponentes() {
    const inep = document.getElementById('inepInput').value;
    const etapa = document.getElementById('selEtapa').value;
    const comps = [...new Set(database.filter(d => String(d.INEP_ESC || d.INEP) === inep && d.ETAPA === etapa).map(d => d.COMPONENTE_CURRICULAR || d.DISCIPLINA))].sort();
    document.getElementById('selComp').innerHTML = comps.map(c => `<option>${c}</option>`).join('');
    render();
}

function render() {
    const inep = document.getElementById('inepInput').value;
    const etapa = document.getElementById('selEtapa').value;
    const comp = document.getElementById('selComp').value;
    const rows = database.filter(d => String(d.INEP_ESC || d.INEP) === inep && d.ETAPA === etapa && (d.COMPONENTE_CURRICULAR === comp || d.DISCIPLINA === comp)).sort((a,b) => a.EDICAO - b.EDICAO);

    document.getElementById('hEscola').innerText = rows[0].ESCOLA || rows[0].NO_MUNICIPIO;
    document.getElementById('hInep').innerText = `INEP: ${inep} | ${etapa} | ${comp}`;

    renderProf(rows);
    renderIde(rows, etapa, comp);
    renderComparacao(rows, etapa, comp);
    renderNiveis([...rows].reverse(), etapa);
    renderHistorico([...rows].reverse());
}

function renderProf(rows) {
    if(chartP) chartP.destroy();
    chartP = new Chart(document.getElementById('chartProf'), {
        type: 'bar',
        data: { labels: rows.map(r => r.EDICAO), datasets: [{ data: rows.map(r => parse(r.PROFICIENCIA_MEDIA).toFixed(2)), backgroundColor: '#4f46e5', borderRadius: 8 }] },
        options: { maintainAspectRatio: false, plugins: { datalabels: { anchor:'end', align:'top', font:{weight:'800'}, formatter: v => v } } }
    });
}

// CORREÇÃO IDE ALFA: Busca por múltiplos nomes de colunas possíveis
function renderIde(rows, etapa, comp) {
    if(chartI) chartI.destroy();
    chartI = new Chart(document.getElementById('chartIde'), {
        type: 'line',
        data: { 
            labels: rows.map(r => r.EDICAO), 
            datasets: [{ 
                label: 'IDE', 
                data: rows.map(r => parse(r.IDE_Alfa) || parse(r.IDE_ALFA) || parse(r.IDE) || 0), 
                borderColor: '#10b981', tension: 0.3, fill: true, backgroundColor: 'rgba(16,185,129,0.1)', pointRadius: 6 
            }] 
        },
        options: { maintainAspectRatio: false, plugins: { datalabels: { align:'top', formatter: v => v.toFixed(2) } } }
    });
}

function renderNiveis(rows, etapa) {
    const cont = document.getElementById('gridNiveis'); cont.innerHTML = '';
    const isA = etapa.includes('2º');
    rows.forEach((row, i) => {
        const id = `cn-${i}`;
        let l, v, c, soma;
        if(isA) {
            l = ['Não Alfab.', 'Incompleta', 'Interm.', 'Sufic.', 'Desej.'];
            v = [parse(row.NAO_ALFABETIZADOS), parse(row.ALFABETIZACAO_INCOMPLETA), parse(row.INTERMEDIARIO), parse(row.SUFICIENTE), parse(row.DESEJAVEL)];
            c = ['#ef4444', '#f97316', '#facc15', '#4ade80', '#166534'];
            soma = (v[3] + v[4]).toFixed(2);
        } else {
            l = ['M. Crítico', 'Crítico', 'Interm.', 'Adequado'];
            v = [parse(row.MUITO_CRITICO), parse(row.CRITICO), parse(row.INTERMEDIARIO), parse(row.ADEQUADO)];
            c = ['#ef4444', '#facc15', '#4ade80', '#166534'];
            soma = (v[2] + v[3]).toFixed(2);
        }
        const cor = soma > 75 ? 'card-excelente' : (soma > 50 ? 'card-bom' : (soma > 25 ? 'card-alerta' : 'card-critico'));
        cont.innerHTML += `<div class="glass-card"><div class="row align-items-center"><div class="col-md-9 border-end"><h6>Edição ${row.EDICAO}</h6><div style="height:120px"><canvas id="${id}"></canvas></div></div><div class="col-md-3 text-center"><div class="p-3 rounded-4 ${cor} shadow-sm"><small class="fw-bold">APRENDIZAGEM</small><h2 class="fw-800 mb-0">${soma}%</h2></div></div></div></div>`;
        setTimeout(() => {
            new Chart(document.getElementById(id), {
                type: 'bar', data: { labels: [''], datasets: l.map((lab, idx) => ({ label: lab, data: [v[idx].toFixed(2)], backgroundColor: c[idx] })) },
                options: { indexAxis: 'y', maintainAspectRatio: false, plugins: { legend: { position: 'bottom' }, datalabels: { color: '#000', font: { weight: 'bold' }, formatter: v => v > 0 ? v + '%' : '' } }, scales: { x: { stacked: true, max: 100, display: false }, y: { stacked: true, display: false } } }
            });
        }, 200);
    });
}

// FUNÇÕES DE APOIO ORIGINAIS PRESERVADAS
function renderComparacao(rowsEscola, etapa, comp) {
    const cont = document.getElementById('gridComparativo');
    cont.innerHTML = '<h5 class="fw-bold mb-4">Rede Municipal</h5>';
    rowsEscola.slice().reverse().forEach(esc => {
        cont.innerHTML += `<div class="glass-card"><b>Edição ${esc.EDICAO}</b> - Proficiência: <span class="val-pill val-esc">${parse(esc.PROFICIENCIA_MEDIA).toFixed(2)}</span></div>`;
    });
}

function renderHistorico(rows) {
    const cont = document.getElementById('gridHistorico');
    cont.innerHTML = '<h5 class="fw-bold mb-4">Evolução</h5>';
    for(let i=0; i<rows.length-1; i++) {
        const d = parse(rows[i].PROFICIENCIA_MEDIA) - parse(rows[i+1].PROFICIENCIA_MEDIA);
        cont.innerHTML += `<div class="glass-card d-flex justify-content-between"><span>${rows[i+1].EDICAO} ➔ ${rows[i].EDICAO}</span><b class="${d>=0?'text-success':'text-danger'}">${d.toFixed(2)} pts</b></div>`;
    }
}

// SUMÁRIO EXECUTIVO DINÂMICO
async function abrirSumario() {
    const inep = document.getElementById('inepInput').value;
    const etapa = document.getElementById('selEtapa').value;
    const comp = document.getElementById('selComp').value;
    const rows = database.filter(d => String(d.INEP_ESC || d.INEP) === inep && d.ETAPA === etapa && (d.COMPONENTE_CURRICULAR === comp || d.DISCIPLINA === comp)).sort((a,b) => a.EDICAO - b.EDICAO);
    const ultima = rows[rows.length-1];

    // Captura Gráficos como Imagem
    document.getElementById('imgProf').src = document.getElementById('chartProf').toDataURL();
    document.getElementById('imgIde').src = document.getElementById('chartIde').toDataURL();

    document.getElementById('sum-header').innerHTML = `
        <h2 class="fw-800 text-dark">${ultima.ESCOLA}</h2>
        <h5 class="text-muted">RELATÓRIO DE DESEMPENHO - ${etapa} (${comp})</h5>
        <span class="badge bg-primary px-3 py-2">INEP: ${inep}</span>
    `;

    document.getElementById('sum-cards-top').innerHTML = `
        <div class="col-md-4"><div class="p-4 bg-light rounded-4 text-center border"><h6>PROFICIÊNCIA MÉDIA</h6><h2 class="fw-800 mb-0">${parse(ultima.PROFICIENCIA_MEDIA).toFixed(2)}</h2></div></div>
        <div class="col-md-4"><div class="p-4 bg-light rounded-4 text-center border"><h6>IDE ÚLTIMO</h6><h2 class="fw-800 mb-0">${(parse(ultima.IDE_Alfa) || parse(ultima.IDE_ALFA) || parse(ultima.IDE)).toFixed(2)}</h2></div></div>
        <div class="col-md-4"><div class="p-4 bg-light rounded-4 text-center border"><h6>EFETIVOS</h6><h2 class="fw-800 mb-0">${ultima.EFETIVOS || ultima.EFETIVO || '---'}</h2></div></div>
    `;

    document.getElementById('sum-niveis-detail').innerHTML = `
        <div class="p-4 bg-white border rounded-4 shadow-sm">
            <p class="mb-0">Na última edição (${ultima.EDICAO}), a escola apresentou um índice de proficiência de <strong>${parse(ultima.PROFICIENCIA_MEDIA).toFixed(2)}</strong>. 
            O desempenho reflete a distribuição dos alunos nos níveis de aprendizagem monitorados pelo SPAECE.</p>
        </div>
    `;

    new bootstrap.Modal(document.getElementById('modalSumario')).show();
}

async function gerarPDF() {
    const area = document.getElementById('print-area');
    const canvas = await html2canvas(area, { scale: 2 });
    const imgData = canvas.toDataURL('image/png');
    const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
    const w = pdf.internal.pageSize.getWidth();
    const h = (canvas.height * w) / canvas.width;
    pdf.addImage(imgData, 'PNG', 0, 0, w, h);
    pdf.save(`Sumario_SPAECE_${document.getElementById('inepInput').value}.pdf`);
}

window.onload = load;
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
