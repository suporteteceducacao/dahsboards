<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPAECE Analytics Pro - Maracanaú</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root { 
            --primary: #0f172a; --accent: #4f46e5; --bg-app: #f1f5f9; --sidebar-w: 300px;
            --cor-muito-critico: #dc2626; --cor-critico: #ff4500; --cor-interm: #ffff00; --cor-adequado: #22c55e; --cor-desejavel: #006400;
        }
        body { background-color: var(--bg-app); font-family: 'Inter', sans-serif; overflow-x: hidden; }

        /* TELA DE ABERTURA - SPLASH */
        #splash-screen {
            position: fixed; inset: 0; z-index: 10000;
            background: #0f172a; display: flex; align-items: center; justify-content: center; color: white;
        }
        .splash-content { text-align: center; }

        /* SIDEBAR */
        #sidebar { 
            width: var(--sidebar-w); height: 100vh; position: fixed; left: 0; top: 0;
            background: var(--primary); color: white; transition: 0.3s; z-index: 1050; padding: 25px;
        }
        #sidebar.collapsed { left: calc(var(--sidebar-w) * -1); }
        #content { margin-left: var(--sidebar-w); transition: 0.3s ease; padding: 30px; min-height: 100vh; }
        #content.expanded { margin-left: 0; }
        
        /* BOTÃO TOGGLE */
        .btn-toggle { position: fixed; left: 265px; top: 20px; z-index: 1100; background: white; border: none; border-radius: 8px; padding: 8px 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        #sidebar.collapsed + .btn-toggle { left: 20px; }

        /* CARDS E NÍVEIS */
        .glass-card { background: white; border-radius: 15px; padding: 20px; border: 1px solid #e2e8f0; margin-bottom: 20px; }
        .bg-interm { background: var(--cor-interm) !important; color: #000 !important; font-weight: bold; }
        .bg-verde-escuro { background: var(--cor-desejavel) !important; color: #fff !important; }
        .bg-vermelho { background: var(--cor-muito-critico) !important; color: #fff !important; }

        /* DROPDOWN CUSTOM */
        .search-container { position: relative; margin-bottom: 20px; }
        #schoolSelect { cursor: pointer; background-color: #1e293b; color: white; border: none; }
        
        .footer-app { padding: 20px; text-align: center; color: #64748b; font-size: 11px; margin-top: 30px; }
    </style>
</head>
<body>

<div id="splash-screen">
    <div class="splash-content">
        <h1 class="fw-800 mb-2">SPAECE ANALYTICS</h1>
        <p class="text-info mb-4">Maracanaú - Gestão de Dados</p>
        <div id="status-box">
            <div class="spinner-border text-light" role="status"></div>
            <p class="mt-3 small">Carregando base de dados...</p>
        </div>
        <button id="btnStart" class="btn btn-primary btn-lg px-5 fw-bold" onclick="iniciar()" style="display:none;">ENTRAR NO SISTEMA</button>
    </div>
</div>

<div id="app" style="display:none;">
    <aside id="sidebar">
        <h4 class="fw-800 mb-5 text-center">PAINEL</h4>
        
        <div class="search-container">
            <label class="small fw-bold opacity-50">SELECIONE A ESCOLA</label>
            <select id="schoolSelect" class="form-select mt-1 mb-3" onchange="selecionarEscola()">
                <option value="">Aguardando dados...</option>
            </select>
        </div>

        <div class="mb-4">
            <label class="small fw-bold opacity-50">ETAPA</label>
            <select id="selEtapa" class="form-select bg-dark text-white border-0 mt-1 mb-3" onchange="popularComponentes()"></select>
            <label class="small fw-bold opacity-50">COMPONENTE</label>
            <select id="selComp" class="form-select bg-dark text-white border-0 mt-1 mb-5" onchange="render()"></select>
        </div>

        <button class="btn btn-info w-100 fw-bold text-white mb-3" onclick="abrirSumario()">SUMÁRIO EXECUTIVO</button>
        <button class="btn btn-outline-danger w-100 btn-sm" onclick="location.reload()">SAIR</button>
    </aside>

    <button class="btn btn-toggle" onclick="toggleMenu()"><i class="fas fa-bars"></i></button>

    <main id="content">
        <header class="mb-4">
            <h2 id="hEscola" class="fw-800 text-primary">---</h2>
            <span id="hInep" class="badge bg-secondary">---</span>
        </header>

        <ul class="nav nav-tabs mb-4 border-0 gap-2">
            <li class="nav-item"><button class="nav-link active fw-bold border-0 rounded-pill" data-bs-toggle="tab" data-bs-target="#t-prof">PROFICIÊNCIA</button></li>
            <li class="nav-item"><button class="nav-link fw-bold border-0 rounded-pill" data-bs-toggle="tab" data-bs-target="#t-ide">IDE</button></li>
            <li class="nav-item"><button class="nav-link fw-bold border-0 rounded-pill" data-bs-toggle="tab" data-bs-target="#t-niveis">NÍVEIS</button></li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="t-prof"><div class="glass-card"><canvas id="chartProf" height="350"></canvas></div></div>
            <div class="tab-pane fade" id="t-ide"><div class="glass-card"><canvas id="chartIde" height="350"></canvas></div></div>
            <div class="tab-pane fade" id="t-niveis"><div id="gridNiveis"></div></div>
        </div>

        <footer class="footer-app">
            © 2026 SME Maracanaú - Todos os direitos reservados.
        </footer>
    </main>
</div>

<div class="modal fade" id="modalSumario" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-body p-0" id="sumario-pdf-area">
                <div id="sumario-content" style="background: white; padding: 50px;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-success fw-bold" onclick="gerarPDF()">BAIXAR RELATÓRIO PDF</button>
            </div>
        </div>
    </div>
</div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxj9fSRN5Vsxmf7er8u4dwv3VG1L3Iba2qg24stpzU5gA-pfttuzXgsyK03-hO9PoL_/exec";
let database = [], chartP = null, chartI = null;

async function load() {
    try {
        const r = await fetch(WEB_APP_URL);
        database = await r.json();
        
        const nomesEscolas = [...new Set(database.map(d => d.ESCOLA || d.NO_MUNICIPIO))].sort();
        const select = document.getElementById('schoolSelect');
        select.innerHTML = '<option value="" disabled selected>Escolha uma escola...</option>' + 
                          nomesEscolas.map(n => `<option value="${n}">${n}</option>`).join('');

        document.getElementById('status-box').style.display = 'none';
        document.getElementById('btnStart').style.display = 'inline-block';
    } catch(e) { alert("Erro ao carregar dados."); }
}

function iniciar() {
    document.getElementById('splash-screen').style.display = 'none';
    document.getElementById('app').style.display = 'block';
}

function selecionarEscola() {
    const nome = document.getElementById('schoolSelect').value;
    const filter = database.filter(d => (d.ESCOLA || d.NO_MUNICIPIO) === nome);
    const etapas = [...new Set(filter.map(d => d.ETAPA))].sort();
    document.getElementById('selEtapa').innerHTML = etapas.map(e => `<option>${e}</option>`).join('');
    popularComponentes();
}

function popularComponentes() {
    const nome = document.getElementById('schoolSelect').value;
    const etapa = document.getElementById('selEtapa').value;
    const comps = [...new Set(database.filter(d => (d.ESCOLA || d.NO_MUNICIPIO) === nome && d.ETAPA === etapa).map(d => d.COMPONENTE_CURRICULAR || d.DISCIPLINA))].sort();
    document.getElementById('selComp').innerHTML = comps.map(c => `<option>${c}</option>`).join('');
    render();
}

function toggleMenu() {
    document.getElementById('sidebar').classList.toggle('collapsed');
    document.getElementById('content').classList.toggle('expanded');
}

function parse(v) { if(!v) return 0; return parseFloat(String(v).replace('%','').replace(',','.')) || 0; }

function render() {
    const nome = document.getElementById('schoolSelect').value;
    const etapa = document.getElementById('selEtapa').value;
    const comp = document.getElementById('selComp').value;
    const rows = database.filter(d => (d.ESCOLA || d.NO_MUNICIPIO) === nome && d.ETAPA === etapa && (d.COMPONENTE_CURRICULAR === comp || d.DISCIPLINA === comp)).sort((a,b) => a.EDICAO - b.EDICAO);

    document.getElementById('hEscola').innerText = nome;
    document.getElementById('hInep').innerText = `INEP: ${rows[0].INEP_ESC || rows[0].INEP}`;

    renderCharts(rows);
    renderNiveis([...rows].reverse(), etapa);
}

function renderCharts(rows) {
    if(chartP) chartP.destroy();
    if(chartI) chartI.destroy();

    chartP = new Chart(document.getElementById('chartProf'), {
        type: 'bar',
        data: { labels: rows.map(r => r.EDICAO), datasets: [{ label: 'Proficiência', data: rows.map(r => parse(r.PROFICIENCIA_MEDIA).toFixed(1)), backgroundColor: '#4f46e5' }] },
        options: { maintainAspectRatio: false }
    });

    chartI = new Chart(document.getElementById('chartIde'), {
        type: 'line',
        data: { labels: rows.map(r => r.EDICAO), datasets: [{ label: 'IDE', data: rows.map(r => (parse(r.IDE_Alfa) || parse(r.IDE)).toFixed(2)), borderColor: '#006400', backgroundColor: 'rgba(0,100,0,0.1)', fill: true }] },
        options: { maintainAspectRatio: false }
    });
}

function renderNiveis(rows, etapa) {
    const cont = document.getElementById('gridNiveis'); cont.innerHTML = '';
    const isA = etapa.includes('2º');
    rows.forEach((row, i) => {
        const labels = isA ? ['Não Alfab.', 'Incompleta', 'Interm.', 'Sufic.', 'Desej.'] : ['M. Crítico', 'Crítico', 'Interm.', 'Adequado'];
        const valores = isA ? [parse(row.NAO_ALFABETIZADOS), parse(row.ALFABETIZACAO_INCOMPLETA), parse(row.INTERMEDIARIO), parse(row.SUFICIENTE), parse(row.DESEJAVEL)] : [parse(row.MUITO_CRITICO), parse(row.CRITICO), parse(row.INTERMEDIARIO), parse(row.ADEQUADO)];
        const cores = isA ? ['#dc2626', '#ff4500', '#ffff00', '#22c55e', '#006400'] : ['#dc2626', '#ff4500', '#ffff00', '#006400'];
        
        let html = `<div class="glass-card"><h6>Edição ${row.EDICAO}</h6><div class="row g-1">`;
        labels.forEach((l, idx) => {
            let bg = l === 'Interm.' ? 'bg-interm' : (l === 'Adequado' || l === 'Desej.' ? 'bg-verde-escuro' : 'bg-vermelho');
            html += `<div class="col text-center p-2 border ${bg}" style="font-size:10px">${l}<br><b>${valores[idx].toFixed(1)}%</b></div>`;
        });
        cont.innerHTML += html + `</div></div>`;
    });
}

async function abrirSumario() {
    const area = document.getElementById('sumario-content');
    const imgProf = document.getElementById('chartProf').toDataURL();
    const imgIde = document.getElementById('chartIde').toDataURL();

    area.innerHTML = `
        <div style="text-align:center; border-bottom: 2px solid #000; padding-bottom:20px; margin-bottom:30px;">
            <h2>${document.getElementById('hEscola').innerText}</h2>
            <h4>Relatório de Desempenho SPAECE</h4>
        </div>
        <div style="display:flex; gap:20px; margin-bottom:40px;">
            <div style="flex:1"><h5>Proficiência</h5><img src="${imgProf}" style="width:100%; border:1px solid #eee;"></div>
            <div style="flex:1"><h5>IDE</h5><img src="${imgIde}" style="width:100%; border:1px solid #eee;"></div>
        </div>
        <div id="pdf-niveis"><h5>Resultados por Níveis</h5></div>
    `;

    document.querySelectorAll('#gridNiveis .glass-card').forEach(card => {
        area.querySelector('#pdf-niveis').appendChild(card.cloneNode(true));
    });

    new bootstrap.Modal(document.getElementById('modalSumario')).show();
}

async function gerarPDF() {
    const el = document.getElementById('sumario-content');
    const canvas = await html2canvas(el, { scale: 2 });
    const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
    pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, 210, (canvas.height * 210) / canvas.width);
    pdf.save("Relatorio_SPAECE.pdf");
}

window.onload = load;
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
