<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SME Maracanaú - Analytics Pro</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root { 
            --primary: #0f172a; --bg-app: #f1f5f9;
            --vml: #dc2626; --lar: #f97316; --ama: #fbbf24; --vcl: #4ade80; --ves: #166534; --blu: #3b82f6;
        }
        body { background-color: var(--bg-app); font-family: 'Inter', sans-serif; overflow-x: hidden; }
        
        /* SIDEBAR RETRÁTIL */
        #sidebar { width: 300px; height: 100vh; position: fixed; background: var(--primary); color: white; padding: 25px; z-index: 1050; transition: all 0.4s ease; left: 0; }
        #sidebar.collapsed { left: -300px; }
        
        #content { margin-left: 300px; padding: 30px; transition: all 0.4s ease; width: calc(100% - 300px); }
        #content.expanded { margin-left: 0; width: 100%; }
        
        .btn-toggle { position: fixed; left: 315px; top: 20px; z-index: 1100; transition: all 0.4s ease; background: white; border: 1px solid #ddd; }
        #sidebar.collapsed + .btn-toggle { left: 15px; }

        .glass-card { 
            background: white; border-radius: 15px; padding: 20px; border: 1px solid #e2e8f0; 
            margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.03);
            animation: slideUp 0.6s ease-out;
        }

        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .badge-perf { padding: 12px; border-radius: 10px; font-weight: 800; text-align: center; color: white; width: 100%; display: block; font-size: 1.1rem; }
        .bg-vml { background: var(--vml); color: white; } 
        .bg-ama { background: var(--ama); color: black; }
        .bg-vcl { background: var(--vcl); color: black; } 
        .bg-ves { background: var(--ves); color: white; }

        #splash { position: fixed; inset: 0; background: var(--primary); z-index: 9999; display: flex; align-items: center; justify-content: center; color: white; text-align: center; }
        
        /* PDF/Sumário */
        .pdf-header { border-bottom: 3px solid var(--primary); margin-bottom: 30px; padding-bottom: 10px; }
        .pdf-title { font-weight: 800; color: var(--primary); text-transform: uppercase; }
        
        .table-technical { font-size: 0.9rem; }
        .table-technical th { background: #f8fafc; color: #475569; text-transform: uppercase; letter-spacing: 0.5px; }
    </style>
</head>
<body>

<div id="splash">
    <div>
        <h1 class="fw-800">MARACANAÚ ANALYTICS</h1>
        <div id="loading"><div class="spinner-border text-light mt-3"></div><p class="mt-2">Sincronizando Dados...</p></div>
        <button id="btnEntrar" class="btn btn-primary px-5 fw-bold" style="display:none;" onclick="iniciar()">ACESSAR SISTEMA</button>
    </div>
</div>

<div id="app" style="display:none;">
    <nav id="sidebar">
        <div class="text-center mb-4">
            <i class="fas fa-graduation-cap fa-2x mb-2"></i>
            <h4 class="fw-800">SME PAINEL</h4>
        </div>
        <label class="small opacity-50 fw-bold">UNIDADE</label>
        <select id="selEscola" class="form-select bg-dark text-white border-0 mb-3 shadow-none" onchange="selecionarEscola()"></select>
        <label class="small opacity-50 fw-bold">ETAPA</label>
        <select id="selEtapa" class="form-select bg-dark text-white border-0 mb-3 shadow-none" onchange="popularComponentes()"></select>
        <label class="small opacity-50 fw-bold">COMPONENTE</label>
        <select id="selComp" class="form-select bg-dark text-white border-0 mb-5 shadow-none" onchange="render()"></select>
        
        <button class="btn btn-info w-100 fw-bold text-white mb-2 shadow" onclick="gerarSumario()">
            <i class="fas fa-file-invoice me-2"></i>SUMÁRIO EXECUTIVO
        </button>
        <button class="btn btn-outline-danger w-100 btn-sm mt-4" onclick="location.reload()">SAIR</button>
    </nav>

    <button class="btn btn-toggle shadow-sm" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>

    <main id="content">
        <header class="mb-4">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 id="hEscola" class="fw-800 text-primary mb-0">---</h2>
                    <span id="hSub" class="badge bg-secondary p-2 mt-2">---</span>
                </div>
            </div>
        </header>

        <ul class="nav nav-pills border-0 mb-4 gap-2">
            <li class="nav-item"><button class="nav-link active fw-bold px-4" data-bs-toggle="pill" data-bs-target="#tab-prof">PROFICIÊNCIA</button></li>
            <li class="nav-item"><button class="nav-link fw-bold px-4" data-bs-toggle="pill" data-bs-target="#tab-ide">IDE</button></li>
            <li class="nav-item"><button class="nav-link fw-bold px-4" data-bs-toggle="pill" data-bs-target="#tab-rede">COMPARAÇÃO REDE</button></li>
            <li class="nav-item"><button class="nav-link fw-bold px-4" data-bs-toggle="pill" data-bs-target="#tab-niveis">NÍVEIS</button></li>
            <li class="nav-item"><button class="nav-link fw-bold px-4 bg-white text-dark border" data-bs-toggle="pill" data-bs-target="#tab-relatorio">RELATÓRIO</button></li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="tab-prof"><div class="glass-card"><canvas id="chartProf" height="380"></canvas></div></div>
            <div class="tab-pane fade" id="tab-ide"><div class="glass-card"><canvas id="chartIde" height="380"></canvas></div></div>
            <div class="tab-pane fade" id="tab-rede"><div id="area-rede"></div></div>
            <div class="tab-pane fade" id="tab-niveis"><div id="area-niveis"></div></div>
            <div class="tab-pane fade" id="tab-relatorio"><div id="area-relatorio" class="glass-card"></div></div>
        </div>
    </main>
</div>

<div class="modal fade" id="modalSumario" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content border-0">
            <div class="modal-header bg-primary text-white">
                <h5 class="fw-bold mb-0">RELATÓRIO DE DESEMPENHO EDUCACIONAL</h5>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-white" id="pdf-content" style="padding: 50px;"></div>
            <div class="modal-footer bg-light">
                <button class="btn btn-success fw-bold px-4" onclick="exportarPDF()"><i class="fas fa-download me-2"></i>SALVAR PDF</button>
            </div>
        </div>
    </div>
</div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxj9fSRN5Vsxmf7er8u4dwv3VG1L3Iba2qg24stpzU5gA-pfttuzXgsyK03-hO9PoL_/exec";
let database = [], chartP = null, chartI = null;
Chart.register(ChartDataLabels);

async function load() {
    try {
        const r = await fetch(WEB_APP_URL);
        database = await r.json();
        const listaEscolas = [...new Set(database.map(d => d.ESCOLA))].filter(Boolean).sort();
        const sel = document.getElementById('selEscola');
        sel.innerHTML = listaEscolas.map(e => `<option value="${e}" ${e.toUpperCase().includes('MARACANAU') ? 'selected' : ''}>${e}</option>`).join('');
        document.getElementById('loading').style.display = 'none';
        document.getElementById('btnEntrar').style.display = 'inline-block';
    } catch(e) { console.error("Erro na carga:", e); }
}

function iniciar() {
    document.getElementById('splash').style.display = 'none';
    document.getElementById('app').style.display = 'block';
    selecionarEscola();
}

function parse(v) { if(!v) return 0; return parseFloat(String(v).replace('%','').replace(',','.')) || 0; }

function toggleSidebar() { 
    const sb = document.getElementById('sidebar');
    const ct = document.getElementById('content');
    sb.classList.toggle('collapsed');
    ct.classList.toggle('expanded');
}

function selecionarEscola() {
    const nome = document.getElementById('selEscola').value;
    const filter = database.filter(d => d.ESCOLA === nome);
    const etapas = [...new Set(filter.map(d => d.ETAPA))].sort();
    document.getElementById('selEtapa').innerHTML = etapas.map(e => `<option>${e}</option>`).join('');
    popularComponentes();
}

function popularComponentes() {
    const nome = document.getElementById('selEscola').value;
    const etapa = document.getElementById('selEtapa').value;
    const comps = [...new Set(database.filter(d => d.ESCOLA === nome && d.ETAPA === etapa).map(d => d.COMPONENTE_CURRICULAR || d.DISCIPLINA))].sort();
    document.getElementById('selComp').innerHTML = comps.map(c => `<option>${c}</option>`).join('');
    render();
}

function render() {
    const nome = document.getElementById('selEscola').value;
    const etapa = document.getElementById('selEtapa').value;
    const comp = document.getElementById('selComp').value;
    const rows = database.filter(d => d.ESCOLA === nome && d.ETAPA === etapa && (d.COMPONENTE_CURRICULAR === comp || d.DISCIPLINA === comp)).sort((a,b) => a.EDICAO - b.EDICAO);

    document.getElementById('hEscola').innerText = nome;
    document.getElementById('hSub').innerText = `${etapa} | ${comp}`;

    renderProf(rows);
    renderIde(rows);
    renderRede(rows, etapa, comp);
    renderNiveis([...rows].reverse(), etapa);
    renderRelatorioTabela(rows);
}

function renderProf(rows) {
    if(chartP) chartP.destroy();
    chartP = new Chart(document.getElementById('chartProf'), {
        type: 'bar',
        data: { labels: rows.map(r => r.EDICAO), datasets: [{ label: 'Proficiência', data: rows.map(r => parse(r.PROFICIENCIA_MEDIA).toFixed(1)), backgroundColor: '#4f46e5', borderRadius: 5 }] },
        options: { 
            animation: { duration: 1500, easing: 'easeOutQuart' },
            maintainAspectRatio: false, 
            plugins: { datalabels: { anchor:'end', align:'top', font:{weight:'bold', size: 14}, formatter: v => v > 0 ? v : '' } } 
        }
    });
}

function renderIde(rows) {
    if(chartI) chartI.destroy();
    chartI = new Chart(document.getElementById('chartIde'), {
        type: 'bar', // Alterado para barras conforme pedido
        data: { labels: rows.map(r => r.EDICAO), datasets: [{ label:'IDE', data: rows.map(r => (parse(r.IDE_Alfa) || parse(r.IDE)).toFixed(1)), backgroundColor: '#166534', borderRadius: 5 }] },
        options: { 
            animation: { duration: 1500 },
            maintainAspectRatio: false, 
            plugins: { datalabels: { anchor:'end', align:'top', font:{weight:'bold', size: 14}, formatter: v => v > 0 ? v : '' } } 
        }
    });
}

function renderRede(rowsEsc, etapa, comp) {
    const cont = document.getElementById('area-rede');
    cont.innerHTML = `<h5 class="fw-800 mb-4 text-secondary">Diferencial de Proficiência vs Rede Municipal</h5>`;
    const baseGeral = database.filter(d => d.ETAPA === etapa && (d.COMPONENTE_CURRICULAR === comp || d.DISCIPLINA === comp));

    rowsEsc.slice().reverse().forEach(esc => {
        const anoData = baseGeral.filter(d => d.EDICAO === esc.EDICAO);
        const linhaMar = anoData.find(d => (d.ESCOLA || "").toUpperCase().includes("MARACANAU"));
        const profRede = parse(linhaMar?.PROFICIENCIA_MEDIA);
        const todasProfs = anoData.map(d => parse(d.PROFICIENCIA_MEDIA)).filter(p => p > 0);
        const max = Math.max(...todasProfs);
        const min = Math.min(...todasProfs);
        const diff = parse(esc.PROFICIENCIA_MEDIA) - profRede;
        const corDiff = diff > 0 ? 'bg-ves' : (diff < 0 ? 'bg-vml' : 'bg-blu');

        cont.innerHTML += `
            <div class="glass-card shadow-sm border-start border-4 border-primary">
                <div class="row align-items-center text-center">
                    <div class="col-md-2"><b>EDIÇÃO ${esc.EDICAO}</b></div>
                    <div class="col-md-2">Escola<br><b class="fs-4">${parse(esc.PROFICIENCIA_MEDIA).toFixed(1)}</b></div>
                    <div class="col-md-2 text-primary">Rede<br><b>${profRede.toFixed(1)}</b></div>
                    <div class="col-md-3"><div class="badge-perf ${corDiff}">${diff > 0 ? '+':''}${diff.toFixed(1)} Pts</div></div>
                    <div class="col-md-3 small">Mín: ${min.toFixed(1)} | Máx: ${max.toFixed(1)}</div>
                </div>
            </div>`;
    });
}

function renderNiveis(rows, etapa) {
    const cont = document.getElementById('area-niveis'); cont.innerHTML = '';
    const isAlfa = etapa.includes('2º');

    rows.forEach((row, i) => {
        const id = `chNiv-${i}`;
        let l, v, c, soma;
        if(isAlfa) {
            l = ['Não Alfab.', 'Incompleta', 'Intermed.', 'Suficiente', 'Desejável'];
            v = [parse(row.NAO_ALFABETIZADOS), parse(row.ALFABETIZACAO_INCOMPLETA), parse(row.INTERMEDIARIO), parse(row.SUFICIENTE), parse(row.DESEJAVEL)];
            c = ['#dc2626', '#f97316', '#fbbf24', '#4ade80', '#166534'];
            soma = v[3] + v[4];
        } else {
            l = ['Muito Crítico', 'Crítico', 'Intermediário', 'Adequado'];
            v = [parse(row.MUITO_CRITICO), parse(row.CRITICO), parse(row.INTERMEDIARIO), parse(row.ADEQUADO)];
            c = ['#dc2626', '#fbbf24', '#4ade80', '#166534'];
            soma = v[2] + v[3];
        }

        cont.innerHTML += `
            <div class="glass-card">
                <div class="row align-items-center">
                    <div class="col-md-8"><h6>Edição ${row.EDICAO} - Distribuição por Níveis</h6><div style="height:120px"><canvas id="${id}"></canvas></div></div>
                    <div class="col-md-4 text-center">
                        <div class="badge-perf ${soma > 75 ? 'bg-ves' : (soma > 50 ? 'bg-vcl' : 'bg-ama')}">
                            APRENDIZAGEM<br><span class="fs-2">${soma.toFixed(1)}%</span>
                        </div>
                    </div>
                </div>
            </div>`;

        setTimeout(() => {
            new Chart(document.getElementById(id), {
                type: 'bar', data: { labels: [''], datasets: l.map((lab, idx) => ({ label: lab, data: [v[idx].toFixed(1)], backgroundColor: c[idx] })) },
                options: { 
                    indexAxis: 'y', maintainAspectRatio: false, 
                    plugins: { 
                        legend: { display: false }, 
                        datalabels: { 
                            color: (ctx) => (ctx.dataset.backgroundColor === '#dc2626' || ctx.dataset.backgroundColor === '#166534') ? '#fff' : '#000',
                            font: {weight: 'bold', size: 14}, 
                            formatter: val => val > 0 ? val + '%' : '' 
                        } 
                    }, 
                    scales: { x: { stacked: true, display: false }, y: { stacked: true, display: false } } 
                }
            });
        }, 400);
    });
}

function renderRelatorioTabela(rows) {
    const cont = document.getElementById('area-relatorio');
    let html = `
        <h5 class="fw-800 mb-4"><i class="fas fa-table me-2"></i>Quadro Resumo Técnico</h5>
        <div class="table-responsive">
            <table class="table table-hover table-technical">
                <thead>
                    <tr>
                        <th>Edição</th>
                        <th>Proficiência</th>
                        <th>IDE</th>
                        <th>Aprendizagem %</th>
                        <th>Participação %</th>
                    </tr>
                </thead>
                <tbody>`;
    
    [...rows].reverse().forEach(r => {
        const etapa = document.getElementById('selEtapa').value;
        const apren = etapa.includes('2º') ? (parse(r.SUFICIENTE) + parse(r.DESEJAVEL)) : (parse(r.INTERMEDIARIO) + parse(r.ADEQUADO));
        html += `
            <tr>
                <td class="fw-bold text-primary">${r.EDICAO}</td>
                <td>${parse(r.PROFICIENCIA_MEDIA).toFixed(1)}</td>
                <td>${(parse(r.IDE_Alfa) || parse(r.IDE)).toFixed(1)}</td>
                <td class="fw-bold">${apren.toFixed(1)}%</td>
                <td>${parse(r.TAXA_PARTICIPACAO).toFixed(1)}%</td>
            </tr>`;
    });
    
    html += `</tbody></table></div>`;
    cont.innerHTML = html;
}

async function gerarSumario() {
    const area = document.getElementById('pdf-content');
    area.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-primary"></div><p>Gerando arquivos...</p></div>';
    
    const imgProf = document.getElementById('chartProf').toDataURL('image/png', 1.0);
    const imgIde = document.getElementById('chartIde').toDataURL('image/png', 1.0);

    area.innerHTML = `
        <div class="pdf-header row align-items-center">
            <div class="col-8">
                <h1 class="pdf-title mb-0">SME Maracanaú</h1>
                <p class="mb-0 fw-bold">Gestão de Resultados Educacionais - SPAECE</p>
            </div>
            <div class="col-4 text-end small">
                <b>Unidade:</b> ${document.getElementById('hEscola').innerText}<br>
                <b>Data:</b> ${new Date().toLocaleDateString()}
            </div>
        </div>
        <div class="row mb-5 g-4">
            <div class="col-6">
                <div class="p-3 border rounded text-center">
                    <h6 class="fw-bold mb-3 text-primary">Proficiência Média</h6>
                    <img src="${imgProf}" style="width:100%;">
                </div>
            </div>
            <div class="col-6">
                <div class="p-3 border rounded text-center">
                    <h6 class="fw-bold mb-3 text-primary">IDE Consolidade</h6>
                    <img src="${imgIde}" style="width:100%;">
                </div>
            </div>
        </div>
        <div id="pdf-detalhes-area"><h5 class="fw-800 border-bottom pb-2 mb-4">Análise por Níveis</h5></div>`;

    document.querySelectorAll('#area-niveis .glass-card').forEach(card => {
        const clone = card.cloneNode(true);
        const canv = card.querySelector('canvas');
        if(canv) {
            const img = document.createElement('img');
            img.src = canv.toDataURL('image/png');
            img.style.width = "100%";
            clone.querySelector('canvas').replaceWith(img);
        }
        area.querySelector('#pdf-detalhes-area').appendChild(clone);
    });

    new bootstrap.Modal(document.getElementById('modalSumario')).show();
}

async function exportarPDF() {
    const el = document.getElementById('pdf-content');
    const canvas = await html2canvas(el, { scale: 2, useCORS: true });
    const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
    pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 10, 10, 190, (canvas.height * 190) / canvas.width);
    pdf.save(`Relatorio_SME_${document.getElementById('hEscola').innerText}.pdf`);
}

window.onload = load;
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
