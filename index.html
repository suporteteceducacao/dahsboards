<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPAECE Analytics Pro V14.4 - LIVE</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style> /* ... Seu CSS Original ... */ </style>
</head>
<body>

<div id="login-overlay">
    <div class="login-card">
        <h4 class="fw-800">SPAECE ANALYTICS</h4>
        <input type="text" id="inepInput" class="form-control text-center mb-3" placeholder="Código INEP da Escola">
        <button id="btnEntrar" class="btn btn-primary w-100 fw-bold" onclick="entrar()">
            VERIFICAR DADOS <i class="fas fa-sync fa-spin" id="loader" style="display:none"></i>
        </button>
    </div>
</div>

<div id="app" style="display:none;">
    <aside id="sidebar">
        <div class="mt-5 text-center mb-5"><h5 class="fw-800">DASHBOARD LIVE</h5></div>
        <select id="selEtapa" class="form-select bg-dark text-white mb-4" onchange="popularComponentes()"></select>
        <select id="selComp" class="form-select bg-dark text-white mb-5" onchange="render()"></select>
        <button class="btn btn-danger w-100 fw-bold" onclick="location.reload()">VOLTAR</button>
    </aside>

    <main id="content">
        <header class="mb-4 pt-3">
            <h2 id="hEscola" class="fw-800 text-primary">---</h2>
            <p id="hInep" class="text-muted">---</p>
        </header>
        <div class="tab-content" id="pills-tabContent">
            <div class="tab-pane fade show active" id="p-prof">
                <div class="glass-card"><canvas id="chartProf"></canvas></div>
            </div>
            </div>
    </main>
</div>

<script>
// 1. INSIRA A URL DA SUA IMPLANTAÇÃO AQUI
const WEB_APP_URL = "SUA_URL_DO_GOOGLE_APPS_SCRIPT";

let database = [];
let chartP = null, chartI = null;
Chart.register(ChartDataLabels);

async function carregarDadosSheet() {
    document.getElementById('loader').style.display = 'inline-block';
    try {
        const resp = await fetch(WEB_APP_URL);
        database = await resp.json();
    } catch (e) {
        alert("Erro ao conectar com a planilha.");
    } finally {
        document.getElementById('loader').style.display = 'none';
    }
}

function entrar() {
    const inep = document.getElementById('inepInput').value;
    // O código busca o INEP independente da coluna se chamar INEP_ESC ou INEP
    const userRows = database.filter(d => String(d.INEP_ESC || d.INEP) == inep);
    
    if(userRows.length > 0) {
        document.getElementById('login-overlay').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        
        const etapas = [...new Set(userRows.map(d => d.ETAPA))].sort();
        document.getElementById('selEtapa').innerHTML = etapas.map(e => `<option>${e}</option>`).join('');
        popularComponentes();
    } else {
        alert("INEP não encontrado na planilha!");
    }
}

function popularComponentes() {
    const inep = document.getElementById('inepInput').value;
    const etapa = document.getElementById('selEtapa').value;
    const comps = [...new Set(database.filter(d => 
        String(d.INEP_ESC || d.INEP) == inep && d.ETAPA == etapa
    ).map(d => d.COMPONENTE_CURRICULAR || d.DISCIPLINA))].sort();
    
    document.getElementById('selComp').innerHTML = comps.map(c => `<option>${c}</option>`).join('');
    render();
}

function parse(v) { 
    if(v === "" || v === null || v === undefined) return 0;
    return parseFloat(String(v).replace('%','').replace(',','.')) || 0; 
}

function render() {
    const inep = document.getElementById('inepInput').value;
    const etapa = document.getElementById('selEtapa').value;
    const comp = document.getElementById('selComp').value;
    
    const rows = database.filter(d => 
        String(d.INEP_ESC || d.INEP) == inep && 
        d.ETAPA == etapa && 
        (d.COMPONENTE_CURRICULAR == comp || d.DISCIPLINA == comp)
    ).sort((a,b) => a.EDICAO - b.EDICAO);

    if(rows.length > 0) {
        document.getElementById('hEscola').innerText = rows[0].ESCOLA || rows[0].MUNICIPIO;
        document.getElementById('hInep').innerText = `INEP: ${inep} | ${etapa} | ${comp}`;
        
        // Chamada das suas funções originais de gráfico
        renderProf(rows);
        renderIde(rows, etapa, comp);
        // ... (as demais funções renderComparacao, renderNiveis etc permanecem as mesmas)
    }
}

// IMPORTANTE: Mantenha as suas funções renderProf, renderIde, etc. 
// do seu código original, elas funcionarão normalmente com esses dados processados.

window.onload = carregarDadosSheet;
</script>
</body>
</html>
