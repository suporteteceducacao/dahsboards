<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPAECE Analytics - Maracanaú</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root { 
            --primary: #0f172a; --accent: #4f46e5; --bg-app: #f1f5f9; --sidebar-w: 300px;
            /* Cores Oficiais SPAECE */
            --vermelho: #dc2626; --laranja: #f97316; --amarelo: #ffff00; --verde-claro: #86efac; --verde-escuro: #166534;
        }
        body { background-color: var(--bg-app); font-family: 'Inter', sans-serif; }
        #splash-screen { position: fixed; inset: 0; z-index: 10000; background: #0f172a; display: flex; align-items: center; justify-content: center; color: white; text-align: center; }
        #sidebar { width: var(--sidebar-w); height: 100vh; position: fixed; left: 0; top: 0; background: var(--primary); color: white; transition: 0.3s; z-index: 1050; padding: 25px; }
        #sidebar.collapsed { left: calc(var(--sidebar-w) * -1); }
        #content { margin-left: var(--sidebar-w); transition: 0.3s ease; padding: 30px; min-height: 100vh; }
        #content.expanded { margin-left: 0; }
        .btn-toggle { position: fixed; left: 270px; top: 20px; z-index: 1100; background: white; border: 1px solid #ddd; border-radius: 8px; }
        #sidebar.collapsed + .btn-toggle { left: 20px; }
        .glass-card { background: white; border-radius: 20px; padding: 20px; border: 1px solid #e2e8f0; margin-bottom: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .status-badge { padding: 15px; border-radius: 12px; text-align: center; font-weight: 800; border: 1px solid rgba(0,0,0,0.1); width: 100%; }
        
        /* Helpers de Cores */
        .c-vml { background: var(--vermelho) !important; color: white !important; }
        .c-lar { background: var(--laranja) !important; color: white !important; }
        .c-ama { background: var(--amarelo) !important; color: black !important; }
        .c-vcl { background: var(--verde-claro) !important; color: black !important; }
        .c-ves { background: var(--verde-escuro) !important; color: white !important; }
    </style>
</head>
<body>

<div id="splash-screen">
    <div>
        <h1 class="fw-800">SPAECE ANALYTICS</h1>
        <p class="opacity-75 mb-4">SME Maracanaú</p>
        <div id="loader"><div class="spinner-border text-light"></div></div>
        <button id="btnEntrar" class="btn btn-primary px-5 fw-bold" onclick="entrar()" style="display:none;">VER RESULTADOS DA REDE</button>
    </div>
</div>

<div id="app" style="display:none;">
    <aside id="sidebar">
        <h5 class="fw-800 mb-4 text-center">FILTROS</h5>
        <div class="mb-4">
            <label class="small fw-bold opacity-50">ESCOLA / REDE</label>
            <select id="selEscola" class="form-select bg-dark text-white border-0 mb-3" onchange="selecionarEscola()"></select>
            <label class="small fw-bold opacity-50">ETAPA</label>
            <select id="selEtapa" class="form-select bg-dark text-white border-0 mb-3" onchange="popularComponentes()"></select>
            <label class="small fw-bold opacity-50">COMPONENTE</label>
            <select id="selComp" class="form-select bg-dark text-white border-0 mb-5" onchange="render()"></select>
        </div>
        <button class="btn btn-info w-100 fw-bold text-white mb-3" onclick="abrirSumario()">SUMÁRIO EXECUTIVO</button>
        <button class="btn btn-outline-danger w-100 fw-bold" onclick="location.reload()">SAIR</button>
    </aside>

    <button class="btn btn-toggle shadow-sm" onclick="toggleMenu()"><i class="fas fa-bars"></i></button>

    <main id="content">
        <header class="mb-4">
            <h2 id="hEscola" class="fw-800 text-primary mb-0">---</h2>
            <p id="hInep" class="text-muted fw-bold">---</p>
        </header>

        <ul class="nav nav-pills mb-4 gap-2">
            <li class="nav-item"><button class="nav-link active rounded-pill fw-bold" data-bs-toggle="pill" data-bs-target="#p-prof">PROFICIÊNCIA</button></li>
            <li class="nav-item"><button class="nav-link rounded-pill fw-bold" data-bs-toggle="pill" data-bs-target="#p-ide">IDE</button></li>
            <li class="nav-item"><button class="nav-link rounded-pill fw-bold" data-bs-toggle="pill" data-bs-target="#p-rede">REDE</button></li>
            <li class="nav-item"><button class="nav-link rounded-pill fw-bold" data-bs-toggle="pill" data-bs-target="#p-niveis">NÍVEIS</button></li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="p-prof"><div class="glass-card"><canvas id="chartProf" height="350"></canvas></div></div>
            <div class="tab-pane fade" id="p-ide"><div class="glass-card"><canvas id="chartIde" height="350"></canvas></div></div>
            <div class="tab-pane fade" id="p-rede"><div id="gridRede"></div></div>
            <div class="tab-pane fade" id="p-niveis"><div id="gridNiveis"></div></div>
        </div>
    </main>
</div>

<div class="modal fade" id="modalSumario" tabindex="-1">
    <div class="modal-dialog modal-xl"><div class="modal-content"><div class="modal-body" id="sumario-content"></div><div class="modal-footer"><button class="btn btn-success" onclick="gerarPDF()">PDF</button></div></div></div>
</div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxj9fSRN5Vsxmf7er8u4dwv3VG1L3Iba2qg24stpzU5gA-pfttuzXgsyK03-hO9PoL_/exec";
let database = [], chartP = null, chartI = null;
Chart.register(ChartDataLabels);

async function load() {
    try {
        const r = await fetch(WEB_APP_URL);
        database = await r.json();
        const escolas = [...new Set(database.map(d => d.ESCOLA || d.NO_MUNICIPIO))].sort();
        const sel = document.getElementById('selEscola');
        sel.innerHTML = escolas.map(e => `<option value="${e}" ${e.includes('MARACANAU') ? 'selected' : ''}>${e}</option>`).join('');
        document.getElementById('loader').style.display = 'none';
        document.getElementById('btnEntrar').style.display = 'inline-block';
    } catch(e) { console.error(e); }
}

function entrar() {
    document.getElementById('splash-screen').style.display = 'none';
    document.getElementById('app').style.display = 'block';
    selecionarEscola();
}

function selecionarEscola() {
    const nome = document.getElementById('selEscola').value;
    const filter = database.filter(d => (d.ESCOLA || d.NO_MUNICIPIO) === nome);
    const etapas = [...new Set(filter.map(d => d.ETAPA))].sort();
    document.getElementById('selEtapa').innerHTML = etapas.map(e => `<option>${e}</option>`).join('');
    popularComponentes();
}

function popularComponentes() {
    const nome = document.getElementById('selEscola').value;
    const etapa = document.getElementById('selEtapa').value;
    const comps = [...new Set(database.filter(d => (d.ESCOLA || d.NO_MUNICIPIO) === nome && d.ETAPA === etapa).map(d => d.COMPONENTE_CURRICULAR || d.DISCIPLINA))].sort();
    document.getElementById('selComp').innerHTML = comps.map(c => `<option>${c}</option>`).join('');
    render();
}

function parse(v) { if(!v) return 0; return parseFloat(String(v).replace('%','').replace(',','.')) || 0; }
function toggleMenu() { document.getElementById('sidebar').classList.toggle('collapsed'); document.getElementById('content').classList.toggle('expanded'); }

function render() {
    const nome = document.getElementById('selEscola').value;
    const etapa = document.getElementById('selEtapa').value;
    const comp = document.getElementById('selComp').value;
    const rows = database.filter(d => (d.ESCOLA || d.NO_MUNICIPIO) === nome && d.ETAPA === etapa && (d.COMPONENTE_CURRICULAR === comp || d.DISCIPLINA === comp)).sort((a,b) => a.EDICAO - b.EDICAO);

    document.getElementById('hEscola').innerText = nome;
    document.getElementById('hInep').innerText = `INEP: ${rows[0]?.INEP_ESC || rows[0]?.INEP || 'REDE'} | ${etapa} | ${comp}`;

    renderProf(rows);
    renderIde(rows);
    renderRede(rows, etapa, comp);
    renderNiveis([...rows].reverse(), etapa);
}

function renderProf(rows) {
    if(chartP) chartP.destroy();
    chartP = new Chart(document.getElementById('chartProf'), {
        type: 'bar',
        data: { labels: rows.map(r => r.EDICAO), datasets: [{ label: 'Proficiência', data: rows.map(r => parse(r.PROFICIENCIA_MEDIA).toFixed(1)), backgroundColor: '#4f46e5' }] },
        options: { maintainAspectRatio: false, plugins: { datalabels: { anchor:'end', align:'top', font:{weight:'bold'} } } }
    });
}

function renderIde(rows) {
    if(chartI) chartI.destroy();
    chartI = new Chart(document.getElementById('chartIde'), {
        type: 'line',
        data: { labels: rows.map(r => r.EDICAO), datasets: [{ label:'IDE', data: rows.map(r => (parse(r.IDE_Alfa) || parse(r.IDE)).toFixed(2)), borderColor: '#166534', backgroundColor: 'rgba(22,101,52,0.1)', fill: true }] },
        options: { maintainAspectRatio: false, plugins: { datalabels: { align:'top', font:{weight:'bold'} } } }
    });
}

function renderRede(rowsEsc, etapa, comp) {
    const cont = document.getElementById('gridRede'); cont.innerHTML = '';
    const redeCompleta = database.filter(d => d.ETAPA === etapa && (d.COMPONENTE_CURRICULAR === comp || d.DISCIPLINA === comp));

    rowsEsc.slice().reverse().forEach(esc => {
        const anoData = redeCompleta.filter(d => d.EDICAO === esc.EDICAO);
        const redeMedia = parse(anoData.find(d => d.NO_MUNICIPIO?.includes('MARACANAU'))?.PROFICIENCIA_MEDIA);
        const profs = anoData.map(d => parse(d.PROFICIENCIA_MEDIA)).filter(p => p > 0);
        const max = Math.max(...profs); const min = Math.min(...profs);
        const diff = parse(esc.PROFICIENCIA_MEDIA) - redeMedia;

        cont.innerHTML += `<div class="glass-card"><div class="row align-items-center">
            <div class="col-md-2"><b>EDIÇÃO ${esc.EDICAO}</b></div>
            <div class="col-md-3 text-center">Maracanaú: <b>${redeMedia.toFixed(1)}</b></div>
            <div class="col-md-3 text-center border-start border-end">Diferença: <b class="${diff >=0 ? 'text-success':'text-danger'}">${diff > 0 ? '+':''}${diff.toFixed(1)}</b></div>
            <div class="col-md-4 text-center small">Mín: ${min.toFixed(1)} | Máx: ${max.toFixed(1)}</div>
        </div></div>`;
    });
}

function renderNiveis(rows, etapa) {
    const cont = document.getElementById('gridNiveis'); cont.innerHTML = '';
    const isAlfa = etapa.includes('2º');

    rows.forEach((row, i) => {
        const id = `chNiv-${i}`;
        let l, v, c, soma;
        
        if(isAlfa) {
            l = ['Não Alfab.', 'Incompleta', 'Intermed.', 'Suficiente', 'Desejável'];
            v = [parse(row.NAO_ALFABETIZADOS), parse(row.ALFABETIZACAO_INCOMPLETA), parse(row.INTERMEDIARIO), parse(row.SUFICIENTE), parse(row.DESEJAVEL)];
            c = [window.getComputedStyle(document.documentElement).getPropertyValue('--vermelho'), 
                 window.getComputedStyle(document.documentElement).getPropertyValue('--laranja'),
                 window.getComputedStyle(document.documentElement).getPropertyValue('--amarelo'),
                 window.getComputedStyle(document.documentElement).getPropertyValue('--verde-claro'),
                 window.getComputedStyle(document.documentElement).getPropertyValue('--verde-escuro')];
            soma = v[3] + v[4];
        } else {
            l = ['Muito Crítico', 'Crítico', 'Intermediário', 'Adequado'];
            v = [parse(row.MUITO_CRITICO), parse(row.CRITICO), parse(row.INTERMEDIARIO), parse(row.ADEQUADO)];
            c = [window.getComputedStyle(document.documentElement).getPropertyValue('--vermelho'), 
                 window.getComputedStyle(document.documentElement).getPropertyValue('--amarelo'),
                 window.getComputedStyle(document.documentElement).getPropertyValue('--verde-claro'),
                 window.getComputedStyle(document.documentElement).getPropertyValue('--verde-escuro')];
            soma = v[2] + v[3];
        }

        cont.innerHTML += `<div class="glass-card"><div class="row align-items-center">
            <div class="col-md-9"><h6 class="fw-bold">Edição ${row.EDICAO}</h6><div style="height:100px"><canvas id="${id}"></canvas></div></div>
            <div class="col-md-3"><div class="status-badge ${soma > 70 ? 'c-ves' : (soma > 50 ? 'c-vcl' : 'c-lar')}">
                <small>APRENDIZAGEM</small><h2 class="mb-0">${soma.toFixed(1)}%</h2>
            </div></div>
        </div></div>`;

        setTimeout(() => {
            new Chart(document.getElementById(id), {
                type: 'bar', data: { labels: [''], datasets: l.map((lab, idx) => ({ label: lab, data: [v[idx].toFixed(1)], backgroundColor: c[idx] })) },
                options: { indexAxis: 'y', maintainAspectRatio: false, plugins: { legend: { display: false }, datalabels: { formatter: val => val > 5 ? val + '%' : '', color: '#000', font: {weight: 'bold'} } }, scales: { x: { stacked: true, display: false }, y: { stacked: true, display: false } } }
            });
        }, 300);
    });
}

async function abrirSumario() {
    const area = document.getElementById('sumario-content');
    area.innerHTML = `<h3>Relatório ${document.getElementById('selEscola').value}</h3>`;
    new bootstrap.Modal(document.getElementById('modalSumario')).show();
}

window.onload = load;
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
